(function($){function selectSort(e){this.opts={},$.extend(this.opts,selectSort.DEFAULTS,e),this._opts=$.extend(!0,{},this.opts),this.$dom=this.opts.element;if(!this.$dom)throw"selectSort param: element missed";this.init(),instances.push(this)}var sprintf=function(e){var t=arguments,n=!0,r=1;return e=e.replace(/%s/g,function(){var e=t[r++];return typeof e=="undefined"?(n=!1,""):e}),n?e:""},extend=function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e},events={on:function(e,t,n){this.events=this.events||{};var r=this.events;return typeof t=="function"&&(r[e]=r[e]||[],r[e].push({fn:t,context:n||this})),this},trigger:function(e,t){this.events=this.events||{};var n=this.events;return n[e]&&n[e].forEach(function(e){e.fn.apply(e.context||this,[t])}),this}},instances=[];selectSort.DEFAULTS={isMulti:1,updateHeader:0},selectSort.hideAllMenus=function(){instances.forEach(function(e){e.hideMenu()})},extend(selectSort.prototype,events),extend(selectSort.prototype,{init:function(){this.items=this.opts.items||[];if(this.items.length<1)throw"selectSort param: items not an array";this.items.forEach(function(e,t){e.children&&e.isMulti!==0&&e.children.forEach(function(e,t){e.isMulti=1})}),this.$dom.html(""),this.$dom.addClass("super_map_sort"),this.initHeader(),this.bindEvent()},initHeader:function(){var e=this.items;this.$header=$('<section class="filter-header"></section>').appendTo(this.$dom);for(var t=0,n=e.length;t<n;t++){var r=e[t],i=sprintf("items[%s]",t);_class=$.trim([r.active?"active":"",r.type=="sortDesc"?"sort-desc":"",r.type=="sortAsc"?"sort-asc":"",r.children?"filter-child":""].join(" ")),this.$header.append(sprintf(['<div class="filter item %s" data-bind="%s" data-index="%s">','<div class="title">%s</div>',"</div>"].join(""),_class,i,t,r.label))}},initMenu:function(e){var t=this.items[e];if(t.isSubMenu)return this.initMultiMenu(e);var n=this;this.$dom.find(".menu").remove(),this.$menu=$('<div class="menu clearfix"></div>').appendTo(this.$dom);var r=$('<ul class="dropdown" style="margin-top: -10px"></div>').appendTo(this.$menu),i=sprintf("items[%s].children",e);return this.createDropDown(t.children,r,i),this.$menu},initMultiMenu:function(e){var t=this.items[e];this.$menu=this.$dom.find(".menu").remove(),this.$menu=$('<div class="menu menu-sub clearfix"></div>').appendTo(this.$dom),this.$menu.append('<div class="sj"></div>');var n=$('<ul class="nav"></ul>').appendTo(this.$menu),r=-1;t.children.forEach(function(e,t){e.active&&r===-1&&(r=t)}),r==-1&&(r=0,t.children[0].active=1),$.map(t.children,function(t,i){var s=sprintf("items[%s].children[%s]",e,i),o=i==r?"active":"";$(sprintf('<li class="nav-item %s" data-bind="%s">%s</li>',o,s,t.label)).appendTo(n),i!=r&&(t.active=0)});var i=sprintf("items[%s].children[%s].children",e,r),s=t.children[r].children,o=$('<ul class="dropdown"></div>').appendTo(this.$menu);return this.createDropDown(s,o,i),this.adjustNav(),this.$menu},createDropDown:function(e,t,n){t.html(""),$.map(e,function(e,r){e.type!="sortDesc"&&e.type!="sortAsc"&&(e.type="select");var i=sprintf("%s[%s]",n,r),s=$.trim([e.active?"active":"",e.type=="sortDesc"?"sort-desc":"",e.type=="sortAsc"?"sort-asc":"",e.type=="select"?"select":""].join(" ")),o=e.isMulti?1:0;$(sprintf('<li class="item %s" data-bind="%s" data-ismulti="%s">%s</li>',s,i,o,e.label)).appendTo(t)})},adjustNav:function(){if(!this.$menu)return;var e=this.$menu.find(".nav li.nav-item"),t=this.$menu.find(".dropdown li.item"),n=e.length,r=t.length,i=this.$menu.find(".nav");i.find(".nav-blank").remove();if(n<r)for(var s=0,o=r-n;s<o;s++)i.append('<li class="nav-blank"></li>');else{var u=this.$menu.find(".dropdown");for(var s=0,o=n-r;s<o;s++)u.append('<li class="item-blank"></li>')}e.eq(0).hasClass("active")?this.$menu.removeClass("nav-white"):this.$menu.addClass("nav-white")},bindEvent:function(){var e=this;this.$dom.off().on("click",".nav li.nav-item",function(){var t=$(this).data("bind"),n=e.$eval(t)||{},r=$(this).closest(".menu").find(".dropdown");$(this).siblings().removeClass("active"),$(this).siblings().each(function(){$(this).removeClass("active"),e.setActive($(this).data("bind"),0)}),$(this).addClass("active"),e.setActive($(this).data("bind"),1),e.createDropDown(n.children,r,t+".children"),e.adjustNav()}).on("click",".item",function(){if($(this).hasClass("active"))$(this).removeClass("active"),e.hideMenu();else{if($(this).hasClass("filter-child"))$(this).siblings(".filter-child").each(function(){$(this).removeClass("active"),e.setActive($(this).data("bind"),0)}),e.initMenu($(this).data("index"));else{e.hideMenu();if($(this).parent().hasClass("filter-header"))e.opts.isMulti||$(this).siblings().each(function(){$(this).removeClass("active"),e.setActive($(this).data("bind"),0)});else if($(this).data("ismulti")==0){$(this).siblings().each(function(){$(this).removeClass("active"),e.setActive($(this).data("bind"),0)});if(e.opts.updateHeader){var t=$(this).data("bind"),n=e.$eval(t+".label");e.setHeader(t,n)}}}$(this).addClass("active")}var r=$(this).data("bind");$(this).hasClass("filter-child")||(e.setActive(r,+$(this).hasClass("active")),e.trigger("item.click",e.$eval(r)))}).on("click",function(e){e.stopPropagation()})},setActive:function(expression,value){try{eval(sprintf("this.%s.active=%s",expression,value))}catch(e){}},setHeader:function(e,t){var n=e[6];this.$header.find(".title").eq(n).html(t)},$eval:function(expression){var ret="";try{ret=eval(sprintf("this.%s",expression))}catch(ex){ret=""}return typeof ret=="undefined"&&(ret=""),ret},getAllItems:function(){return this.items},reset:function(){this.opts=$.extend(!0,{},this._opts),this.init()},getDom:function(){return this.$dom}}),extend(selectSort.prototype,{hideMenu:function(){this.$menu&&this.$menu.hide(),this.$header.find(".filter-child").removeClass("active")}}),$(document).on("click",function(){selectSort.hideAllMenus()}),typeof define=="function"?define(function(){return selectSort}):this.selectSort=selectSort})($);