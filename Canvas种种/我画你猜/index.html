<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }
        canvas {
            position: relative;
            background: #eee;
        }
    </style>
</head>
<body>
    <canvas id="drawing-pad" width="500" height="400"></canvas>
    <ul id="chat-history"></ul>
    <input type="text" id="chat-input">
    <input type="button" id="btn" value="发送">


    <script>
        let wsGame = {
            // 指示当前是否正在进行绘图
            isDrawing: false,
            // 绘制下一条线的起点
            startX: 0,
            startY: 0,
            LINE_SEGMENT: 0,
            CHAT_MESSAGE: 1
        };

        wsGame.socket = new WebSocket('ws://localhost:9999');
        
        wsGame.socket.onopen = function() {
            console.log('客户端连接成功');
        };

        wsGame.socket.onmessage = function(e) {
            console.log(e.data);
            let data = JSON.parse(e.data);
            if (data.dataType === wsGame.CHAT_MESSAGE) {
                list.appendChild(`<li>${data.message}</li>`);
            } else if (data.dataType === wsGame.LINE_SEGMENT) {
                drawLine(ctx, data.startX, data.startY, data.endX, data.endY, 1);
            }
        };

        wsGame.socket.onclose = function() {
            console.log('连接断开');
        };

        let canvas = document.getElementById('drawing-pad');
        let ctx = canvas.getContext('2d');

        let btn = document.getElementById('btn');
        let txt = document.getElementById('chat-input');
        let list = document.getElementById('chat-history');
        
        btn.addEventListener('click', sendMsg);

        txt.addEventListener('keypress', e => {
            let key = e.keyCode;
            key === 13 && sendMsg();
        });

        function sendMsg() {
            let msg = txt.value;
            if (msg !== '') {
                // 将聊天消息放到对象中
                let data = {};
                data.dataType = wsGame.CHAT_MESSAGE;
                data.message = msg;

                wsGame.socket.send(JSON.stringify(data));
                txt.value = '';
            }
        }

        canvas.addEventListener('mousedown', e => {
            // 获取相对于canvas左上角位置鼠标的x和y坐标
            let top = canvas.offsetTop;
            let left = canvas.offsetLeft;

            let mouseX = (e.clientX - left) || 0;
            let mouseY = (e.clientY - top) || 0;
            wsGame.startX = mouseX;
            wsGame.startY = mouseY;
            wsGame.isDrawing = true;
            console.log(wsGame);
        });

        canvas.addEventListener('mousemove', e => {
            // 当开始进行绘图时，就进行画线操作
            if (wsGame.isDrawing) {
                let top = canvas.offsetTop;
                let left = canvas.offsetTop;
                let X = (e.clientX - left) || 0;
                let Y = (e.clientY - top) || 0;

                if (!(wsGame.startX === X && wsGame.startY === Y)) {
                    drawLine(ctx, wsGame.startX, wsGame.startY, X, Y, 1);
                    // 发送线段数据到服务器
                    let data = {};
                    data.dataType = wsGame.LINE_SEGMENT;
                    data.startX = wsGame.startX;
                    data.startY = wsGame.startY;
                    data.endX = X;
                    data.endY = Y;
                    console.log(data);
                    // wsGame.socket.send(JSON.stringify(data));

                    wsGame.startX = X;
                    wsGame.startY = Y;
                }
            }
        });

        canvas.addEventListener('mouseup', () => {
            wsGame.isDrawing = false;
        });

        function drawLine(ctx, x1, y1, x2, y2, thickness) {
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.lineWidth = thickness;
            ctx.strokeStyle = '#444';
            ctx.stroke();
        }

        
    </script>
</body>
</html>