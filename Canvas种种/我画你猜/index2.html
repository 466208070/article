<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }
        canvas {
            position: relative;
            background: #eee;
        }
    </style>
</head>

<body>
    <canvas id="drawing-pad" width="500" height="400"></canvas>
    <input type="text" id="chat-input">
    <input type="button" id="btn" value="发送">
    <input type="button" id="restart" value="重新开始">
    <ul id="chat-history"></ul>

    <script src="https://cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
    <script src="game.js"></script>
    <script>
        let websocketGame = {
            // 指示当前是否正在进行绘图
            isDrawing: false,
            // 绘制下一条线的起点
            startX: 0,
            startY: 0,
            LINE_SEGMENT: 0,
            CHAT_MESSAGE: 1,
            GAME_LOGIC: 2,
            // 游戏逻辑状态常量
            WAITING_TO_START: 0,
            GAME_START: 1,
            GAME_OVER: 2,
            GAME_RESTART: 3,
            isTurnToDraw: false
        };
        websocketGame.socket = new WebSocket('ws://localhost:9999');

        websocketGame.socket.onopen = function () {
            console.log('客户端连接成功');
        };

        websocketGame.socket.onmessage = function (e) {
            console.log(e.data);
            let data = JSON.parse(e.data);
            
            if (data.dataType === websocketGame.CHAT_MESSAGE) {
                let li = document.createElement('li');
                li.innerHTML = `<li>${data.sender}说： ${data.message}</li>`;
                list.appendChild(li);
            } else if (data.dataType === websocketGame.LINE_SEGMENT) {
                drawLine(ctx, data.startX, data.startY, data.endX, data.endY, 1);
            } else if (data.dataType === websocketGame.GAME_LOGIC) {
                if (data.gameState === websocketGame.GAME_OVER) {
                    websocketGame.isTurnToDraw = false;
                }
            }
        };

        websocketGame.socket.onclose = function () {
            console.log('连接断开');
        };
        // 获取canvas上下文准备绘制
        let canvas = document.getElementById('drawing-pad');
        let ctx = canvas.getContext('2d');

        // mousedown事件
        canvas.addEventListener('mousedown', function (e) {
            let left = this.offsetLeft,
                top = this.offsetTop,
                mouseX = e.clientX - left || 0,
                mouseY = e.clientY - top || 0;

            websocketGame.isDrawing = true;
            websocketGame.startX = mouseX;
            websocketGame.startY = mouseY;
        });
        // mousemove事件
        canvas.addEventListener('mousemove', function (e) {
            if (websocketGame.isDrawing) {
                let left = this.offsetLeft,
                    top = this.offsetTop,
                    mouseX = e.clientX - left || 0,
                    mouseY = e.clientY - top || 0;
                // 鼠标的位置如果和起始点位置不相同，就进行绘制
                if (!(mouseX === websocketGame.startX && mouseY === websocketGame.startY)) {
                    drawLine(ctx, websocketGame.startX, websocketGame.startY, mouseX, mouseY, 1);
                    
                    // + 发送数据到服务端
                    let data = {};
                    data.dataType = websocketGame.LINE_SEGMENT;
                    data.startX = websocketGame.startX;
                    data.startY = websocketGame.startY;
                    data.endX = mouseX;
                    data.endY = mouseY;

                    websocketGame.socket.send(JSON.stringify(data));

                    // 更新起点的位置坐标
                    websocketGame.startX = mouseX;
                    websocketGame.startY = mouseY;
                }
            }
        });
        // mouseup事件
        canvas.addEventListener('mouseup', function() {
            websocketGame.isDrawing = false;
            this.removeEventListener('mousedown', null);
            this.removeEventListener('mousemove', null);
        });

        // 绘制线段
        function drawLine(ctx, x1, y1, x2, y2, thickness) {
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.lineWidth = thickness;
            ctx.strokeStyle = '#00a1f4';
            ctx.stroke();
        }

        let btn = document.getElementById('btn');
        let txt = document.getElementById('chat-input');
        let list = document.getElementById('chat-history');

        btn.addEventListener('click', sendMsg);

        txt.addEventListener('keypress', e => {
            let key = e.keyCode;
            key === 13 && sendMsg();
        });

        function sendMsg() {
            let msg = txt.value;
            // + 聊天消息包装成对象里
            let data = {};
            data.dataType = websocketGame.CHAT_MESSAGE;
            data.message = msg;

            // - websocketGame.socket.send(msg);
            // +
            websocketGame.socket.send(JSON.stringify(data));
            txt.value = '';
        }

        
    </script>
</body>

</html>